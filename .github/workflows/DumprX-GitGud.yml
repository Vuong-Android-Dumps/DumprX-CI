name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-docker-images: 'true'

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build project
        run: |
          git clone --depth=1 --single-branch https://github.com/DumprX/DumprX.git ~/DumprX
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh-keyscan -H gitgud.io >> ~/.ssh/known_hosts
          echo "${{ secrets.PRIV_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          git config --global user.name "VanVuong41429"
          git config --global user.email "vanvuong41429@gmail.com"
          git config --global color.ui auto
          cd ~/DumprX
          echo "${{ secrets.GITGUD_TOKEN }}" > .gitlab_token
          echo "Van-Firmware-Dumps" > .gitlab_group
          echo "@VanFirmwareDumps" > .tg_chat
          echo "${{ secrets.TG_TOKEN }}" > .tg_token
          echo "gitgud.io" > .gitlab_instance
          bash setup.sh
          export PUSH_TO_GITLAB="true"
          ./dumper.sh "no"
