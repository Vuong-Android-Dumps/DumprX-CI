name: Cleanup GitHub Actions Storage
on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:       # Allows manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Authenticate GitHub CLI
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          echo $GIT_TOKEN | gh auth login --with-token

      - name: Delete old artifacts (older than 30 days)
        run: |
          cutoff=$(date -d '30 days ago' --iso-8601=seconds)
          gh run list --limit 100 --json databaseId,createdAt | \
          jq -r ".[] | select(.createdAt < \"$cutoff\") | .databaseId" | \
          xargs -n1 -r gh run delete --confirm

      - name: Delete old caches
        run: |
          caches=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/actions/caches | jq -r '.actions_caches[].id')
          for id in $caches; do
            gh api -X DELETE -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/actions/caches/$id
          done

      - name: Report storage usage
        run: |
          echo "Checking GitHub Actions storage usage..."
          gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/actions/artifacts
