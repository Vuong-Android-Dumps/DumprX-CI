name: Full Cleanup

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GIT_TOKEN }}" | gh auth login --with-token

      # 🔹 Delete all artifacts
      - name: Delete all artifacts
        run: |
          echo "🗑 Deleting artifacts..."
          gh api repos/${{ github.repository }}/actions/artifacts \
            --paginate -q '.artifacts[].id' | \
          xargs -n1 -I {} gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/{} || true

      # 🔹 Delete all caches
      - name: Delete all caches
        run: |
          echo "🗑 Deleting caches..."
          gh cache list --limit 100 | cut -f1 | \
          xargs -n1 gh cache delete || true

      # 🔹 Free up runner disk space (~84GB free)
      - name: Free disk space
        run: |
          echo "📦 Disk usage before cleanup:"
          df -h /

          echo "🧹 Removing large preinstalled SDKs..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/.ghcup || true

          echo "🐳 Cleaning Docker..."
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          echo "🧹 Cleaning APT cache..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo "📦 Disk usage after cleanup:"
          df -h /

      - name: Done
        run: echo "✅ Cleanup complete!"
